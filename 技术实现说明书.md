# 技术实现说明书

## 项目目标
- 在已登录状态下，批量下载「知识星球」目标星球的文件
- 支持订阅列表采集与交互选择、滚动加载全部文件、文件列表打印、下载数量限制、临时目录清理

## 技术栈与运行环境
- 语言：Python 3.x
- 框架：Playwright（Chromium 持久化上下文）
- 操作系统：Windows（当前项目运行环境）

## 核心架构
- 持久化上下文：使用 launch_persistent_context 维持登录态与本地数据目录
  - 入口：[start_browser](file:///d:/aicode/zsxq/zsxq_playwright.py#L33-L68)
- 登录状态检测与等待手动登录
  - 检测：[check_login_status](file:///d:/aicode/zsxq/zsxq_playwright.py#L77-L112)
  - 等待：[wait_for_login](file:///d:/aicode/zsxq/zsxq_playwright.py#L114-L125)
- 订阅采集与选择（仅 /group）
  - 采集滚动：[list_subscriptions](file:///d:/aicode/zsxq/zsxq_playwright.py#L127-L231)
  - 打印订阅：[print_subscriptions](file:///d:/aicode/zsxq/zsxq_playwright.py#L244-L252)
  - 交互选择：[choose_subscription](file:///d:/aicode/zsxq/zsxq_playwright.py#L255-L270)
  - 打开订阅：[open_subscription](file:///d:/aicode/zsxq/zsxq_playwright.py#L272-L285)
- 文件入口导航（右侧“星球文件”）
  - 多策略定位与兜底：[click_files_entry](file:///d:/aicode/zsxq/zsxq_playwright.py#L197-L245)
- 文件列表采集与滚动加载
  - DOM 扫描提取文件名：[get_file_elements](file:///d:/aicode/zsxq/zsxq_playwright.py#L246-L329)
  - 滚动收集与去重：[load_all_files](file:///d:/aicode/zsxq/zsxq_playwright.py#L330-L379)
- 文件下载与兜底保存
  - 智能定位“下载”按钮 + 事件监听 + JS 点击：[download_file](file:///d:/aicode/zsxq/zsxq_playwright.py#L510-L744)
  - 事件未触发时的临时目录稳定文件检测：[ _wait_for_completed_file ](file:///d:/aicode/zsxq/zsxq_playwright.py#L425-L447)
- 临时目录清理
  - 清理残留与目录删除：[ _cleanup_temp ](file:///d:/aicode/zsxq/zsxq_playwright.py#L609-L629) / [ _remove_temp_dir ](file:///d:/aicode/zsxq/zsxq_playwright.py#L662-L669)
- 主流程编排
  - 登录 → 订阅采集/选择 → 点击“星球文件” → 滚动次数确认 → 文件列表打印 → 下载数量确认 → 批量下载 → 清理：[download_all](file:///d:/aicode/zsxq/zsxq_playwright.py#L906-L941)

## 关键数据与状态
- 下载目录（绝对路径）：downloads/zsxq_files
- 临时下载目录：downloads/zsxq_files/temp_cache（由持久化上下文下载路径指向）
- 用户数据目录：browser_data/zsxq（存储登录态）
- 集合去重：订阅（名称+href）、文件（文件名）
- 交互输入：订阅选择、滚动次数确认、下载数量确认

## 核心算法与策略
- 订阅采集（仅 /group）
  - 选择器：a[href*="/group"]，限定在侧栏/导航区域（通过容器 rect 包含校验）
  - 过滤词：发现/优质/推荐等非订阅词
  - 去重：名称+href 组合键；最终按 href 包含 /group 的项输出
- 文件检测与提取
  - 扫描所有元素文本，基于扩展名 regex 提取文件名，限定可见元素与合适长度
  - 文件去重基于文件名字符串 Set
- 滚动加载（文件与订阅）
  - 每次滚动后采集，计算新增数；连续若干次无新增或到达底部停止
  - 文件滚动次数由用户交互输入确认
- 下载按钮定位评分
  - 文本匹配“下载”、可见与尺寸、cursor=pointer、位置分数综合
  - 坐标点击与 JS 点击双策略触发下载事件
- 下载兜底与保存重命名
  - 若事件未触发，检测临时目录中最新稳定文件（非 .crdownload/.tmp、大小稳定）并移动至目标目录
  - 文件名清理非法字符后保存
- 临时目录清理
  - 下载成功后删除源码文件与临时目录，避免缓存残留与用户反馈问题

## 可配置参数
- 在 main 中配置：
  - PLANET_NAME、DOWNLOAD_DIR、USER_DATA_DIR、MAX_FILES、DEBUG_MODE
  - SUBS_SCROLL_LIMIT（订阅滚动上限）、FILES_SCROLL_LIMIT（文件滚动默认值）
  - 入口：[main](file:///d:/aicode/zsxq/zsxq_playwright.py#L968-L1005)

## 异常处理与鲁棒性
- 浏览器启动失败：提示关闭残留实例、权限与数据目录锁定
- 未登录：引导手动登录并继续
- 找不到“星球文件”：多策略查找与手动兜底提示
- 下载事件未触发：临时目录稳定文件兜底保存
- 弹窗关闭：按键、按钮、点击外部区域三重策略

## 验证与测试
- 语法编译检查：python -m py_compile zsxq_playwright.py
- 手工验证流程：登录 → 订阅列表打印 → 选择订阅 → 点击“星球文件” → 输入滚动次数 → 文件列表打印 → 输入下载数量 → 下载完成后临时目录被清理

## 约束与注意事项
- 页面结构变更可能导致选择器失效，需要根据实际 DOM 调整
- 大量文件滚动采集需要适当的 pause 与上限，避免过度滚动
- 请勿在仓库中提交任何敏感信息（登录态目录仅本地使用）

## 未来扩展
- 参数化 CLI：订阅过滤、文件类型筛选、时间范围、关键字过滤
- 非交互运行模式：用于定时任务或批处理
- 更稳健的选择器与数据来源：减少对文本的依赖
- 失败重试与断点续传：对大文件与网络波动更友好

